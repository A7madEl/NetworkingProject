@model IEnumerable<Book>
@{
    ViewBag.Title = "Books";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .book-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
    }

    .book-card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        width: 300px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .book-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .book-card-body {
        padding: 1rem;
        flex-grow: 1;
    }

    .book-card-body h5 {
        font-size: 1.2rem;
        color: #007bff;
        margin-bottom: 0.5rem;
    }

    .book-card-body p {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .book-card-footer {
        padding: 1rem;
        background-color: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .book-card-footer .btn {
        font-size: 0.9rem;
    }

    .back-to-list-btn {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background-color: transparent;
        border: 1px solid #007bff;
        color: #007bff;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
    }

    .back-to-list-btn:hover {
        background-color: #007bff;
        color: #fff;
    }
</style>

<h1>Books</h1>

<!-- Filter Form -->
<form method="get" asp-action="UserIndex">
    <div class="form-group">
        <label for="category">Filter by Category:</label>
        <select id="category" name="category" class="form-control">
            <option value="">All</option>
            @foreach (var category in ViewBag.Categories)
            {
                var isSelected = category == ViewBag.SelectedCategory ? "selected" : null;
                <option value="@category" selected="@isSelected">@category</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label for="searchQuery">Search:</label>
        <input type="text" id="searchQuery" name="searchQuery" class="form-control" value="@ViewBag.SearchQuery" onkeyup="searchBooks()" placeholder="Search for books...">
    </div>
    <button type="submit" class="btn btn-primary">Filter</button>
</form>

<!-- Books List -->
<div id="bookList" class="book-list mt-4">
    @foreach (var book in Model)
    {
        <a asp-action="Details" asp-route-id="@book.BookId">
            <div class="book-card">
                <img src="@Url.Content("~/images/" + book.ImageUrl)" alt="@book.Description" />
                <div class="book-card-body">
                    <h5>@book.Title</h5>
                    <p>@book.Description</p>
                    <p><strong>Published:</strong> @book.YearPublished</p>
                    <p><strong>Category:</strong> @book.Category</p>
                    <div>
                        @if (book.DiscountEndDate.HasValue && book.DiscountEndDate.Value > DateTime.Now)
                        {
                            <p class="card-text" style="color: #dc3545; font-weight: bold; font-size: 1rem;">
                                Discount ends in: <span id="countdown-@book.BookId"></span>
                            </p>

                            var originalPrice = book.BuyPrice / (1 - (book.DiscountPrice.Value / 100));

                            <p class="card-text" style="color: #dc3545; font-weight: bold; font-size: 1.2rem;">
                                <span>@book.DiscountPrice.Value% off</span>
                            </p>

                            <p class="card-text" style="color: #dc3545; font-weight: bold; font-size: 1.2rem;">
                                <span style="text-decoration: line-through; color: #6c757d;">@originalPrice.ToString("c")</span>
                            </p>

                            <!-- Pass BookId and DiscountEndDate to JavaScript -->
                            <script>
                                var bookId = @book.BookId;
                                var discountEndDate = '@book.DiscountEndDate.Value.ToString("yyyy-MM-ddTHH:mm:ss")';
                                initCountdown(bookId, discountEndDate); // Initialize the countdown
                            </script>
                        }
                        <span style="color: #28a745;">@book.BuyPrice.ToString("c")</span>
                    </div>
                </div>
            </div>
        </a>
    }
   </div>

<script>
    function searchBooks() {
        var searchQuery = document.getElementById('searchQuery').value;
        var category = document.getElementById('category').value;

        $.ajax({
            url: '@Url.Action("UserIndex", "Book")',
            type: 'GET',
            data: { category: category, searchQuery: searchQuery },
            success: function (result) {
                $('#bookList').html(result);
            }
        });
    }
</script>
<script>
    // Function to initialize the countdown
    function initCountdown(bookId, discountEndDate) {
        // Convert the discount end date to a JavaScript Date object
        var endDate = new Date(discountEndDate);

        // Get the countdown element for this book
        var countdownElement = document.getElementById("countdown-" + bookId);

        // Update the countdown every second
        var countdownInterval = setInterval(function () {
            // Get the current date and time
            var now = new Date().getTime();

            // Calculate the remaining time
            var timeRemaining = endDate - now;

            // If the discount has ended, clear the interval and display a message
            if (timeRemaining <= 0) {
                clearInterval(countdownInterval);
                countdownElement.innerHTML = "Discount ended!";
                return;
            }

            // Calculate days, hours, minutes, and seconds
            var days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
            var hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

            // Display the countdown
            countdownElement.innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s";
        }, 1000); // Update every second
    }
</script>